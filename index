import React, { useState, useEffect, useMemo } from 'react';
import { 
  Sparkles, 
  Moon, 
  Sun, 
  RotateCcw, 
  BookOpen, 
  User, 
  ChevronRight, 
  Loader2,
  RefreshCw
} from 'lucide-react';

const apiKey = ""; // Runtime provided

// --- Tarot Deck Data ---
const TAROT_DECK = [
  { name: "The Fool", image: "ðŸƒ", meaning: "New beginnings, optimism, trust in life." },
  { name: "The Magician", image: "ðŸª„", meaning: "Action, power, manifestation, resourcefulness." },
  { name: "The High Priestess", image: "ðŸŒ™", meaning: "Intuition, sacred knowledge, the subconscious mind." },
  { name: "The Empress", image: "ðŸŒ¿", meaning: "Femininity, beauty, nature, nurturing, abundance." },
  { name: "The Emperor", image: "ðŸ‘‘", meaning: "Authority, structure, a father figure, foundation." },
  { name: "The Hierophant", image: "â›ª", meaning: "Spiritual wisdom, religious beliefs, tradition." },
  { name: "The Lovers", image: "â¤ï¸", meaning: "Love, harmony, relationships, values alignment." },
  { name: "The Chariot", image: "ðŸ‡", meaning: "Control, willpower, victory, determination." },
  { name: "Strength", image: "ðŸ¦", meaning: "Strength, courage, persuasion, influence, compassion." },
  { name: "The Hermit", image: "ðŸ•¯ï¸", meaning: "Soul-searching, introspection, being alone, inner guidance." },
  { name: "Wheel of Fortune", image: "ðŸŽ¡", meaning: "Good luck, karma, life cycles, destiny, a turning point." },
  { name: "Justice", image: "âš–ï¸", meaning: "Justice, fairness, truth, cause and effect, law." },
  { name: "The Hanged Man", image: "ðŸ¦¶", meaning: "Pause, surrender, letting go, new perspectives." },
  { name: "Death", image: "ðŸ’€", meaning: "Endings, change, transformation, transition." },
  { name: "Temperance", image: "ðŸ·", meaning: "Balance, moderation, patience, purpose." },
  { name: "The Devil", image: "ðŸ˜ˆ", meaning: "Shadow self, attachment, addiction, restriction." },
  { name: "The Tower", image: "ðŸ°", meaning: "Sudden change, upheaval, chaos, revelation." },
  { name: "The Star", image: "â­", meaning: "Hope, faith, purpose, renewal, spirituality." },
  { name: "The Moon", image: "ðŸŒ•", meaning: "Illusion, fear, anxiety, subconscious, intuition." },
  { name: "The Sun", image: "ðŸŒž", meaning: "Positivity, fun, warmth, success, vitality." },
  { name: "Judgement", image: "ðŸŽº", meaning: "Judgement, rebirth, inner calling, absolution." },
  { name: "The World", image: "ðŸŒ", meaning: "Completion, integration, accomplishment, travel." }
];

const ZODIAC_SIGNS = [
  "Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", 
  "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"
];

// --- Components ---

const Card = ({ card, isFlipped, onClick, index }) => {
  return (
    <div 
      onClick={onClick}
      className={`relative w-24 h-36 md:w-32 md:h-48 cursor-pointer transition-all duration-700 transform preserve-3d ${isFlipped ? 'rotate-y-180' : ''}`}
      style={{ perspective: '1000px' }}
    >
      {/* Back of Card */}
      <div className={`absolute inset-0 bg-indigo-950 rounded-xl border-2 border-amber-400/30 flex items-center justify-center shadow-lg backface-hidden ${isFlipped ? 'hidden' : 'block'}`}>
        <div className="text-amber-500 opacity-50 flex flex-col items-center">
          <Moon size={32} />
          <div className="text-[8px] mt-2 uppercase tracking-widest font-serif">Mystic</div>
        </div>
      </div>
      
      {/* Front of Card */}
      <div className={`absolute inset-0 bg-white rounded-xl border-2 border-amber-500 flex flex-col items-center justify-center p-2 shadow-xl backface-hidden rotate-y-180 ${isFlipped ? 'block' : 'hidden'}`}>
        <div className="text-4xl mb-2">{card?.image}</div>
        <div className="text-indigo-900 font-serif font-bold text-center text-xs md:text-sm">{card?.name}</div>
      </div>
    </div>
  );
};

export default function App() {
  const [selectedSign, setSelectedSign] = useState(null);
  const [step, setStep] = useState('sign-selection'); // 'sign-selection', 'shuffling', 'reading'
  const [drawnCards, setDrawnCards] = useState([]);
  const [readingText, setReadingText] = useState("");
  const [isLoadingReading, setIsLoadingReading] = useState(false);
  const [deck, setDeck] = useState([...TAROT_DECK]);

  const shuffleDeck = () => {
    const newDeck = [...TAROT_DECK].sort(() => Math.random() - 0.5);
    setDeck(newDeck);
    setDrawnCards([]);
    setReadingText("");
  };

  const handleDrawCard = (index) => {
    if (drawnCards.length >= 3) return;
    const card = deck[index];
    if (drawnCards.find(c => c.name === card.name)) return;
    
    setDrawnCards(prev => [...prev, card]);
  };

  const autoDraw = () => {
    const shuffled = [...TAROT_DECK].sort(() => Math.random() - 0.5);
    setDrawnCards(shuffled.slice(0, 3));
  };

  const generateReading = async () => {
    if (drawnCards.length < 3) return;
    setIsLoadingReading(true);
    setStep('interpretation');

    const prompt = `Give a spiritual tarot reading for a ${selectedSign} individual. 
    They have drawn these three cards:
    1. Past: ${drawnCards[0].name}
    2. Present: ${drawnCards[1].name}
    3. Future: ${drawnCards[2].name}
    
    Format the response as a cohesive story relating their zodiac sign's traits to these cards. Keep it under 200 words.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setReadingText(text || "The stars are silent right now. Try again soon.");
    } catch (error) {
      setReadingText("Connectivity issues with the spiritual realm. Please check your signal.");
    } finally {
      setIsLoadingReading(false);
    }
  };

  const reset = () => {
    setStep('sign-selection');
    setDrawnCards([]);
    setReadingText("");
    setSelectedSign(null);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-amber-500/30">
      {/* Background Ambience */}
      <div className="fixed inset-0 pointer-events-none overflow-hidden">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-900/20 blur-[120px] rounded-full"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/20 blur-[120px] rounded-full"></div>
      </div>

      <header className="relative z-10 p-6 flex items-center justify-between border-b border-white/10 backdrop-blur-md sticky top-0">
        <div className="flex items-center gap-2">
          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <Sparkles className="text-white" size={20} />
          </div>
          <h1 className="text-xl font-serif font-bold tracking-tight">Stellar Tarot</h1>
        </div>
        {selectedSign && (
          <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
            <User size={14} className="text-amber-400" />
            <span className="text-xs font-medium uppercase tracking-widest">{selectedSign}</span>
          </div>
        )}
      </header>

      <main className="relative z-10 max-w-4xl mx-auto p-6 pb-24">
        
        {/* Step 1: Sign Selection */}
        {step === 'sign-selection' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div className="text-center space-y-2">
              <h2 className="text-3xl font-serif">Welcome, seeker</h2>
              <p className="text-slate-400">Select your zodiac sign to align the cards with your energy.</p>
            </div>
            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
              {ZODIAC_SIGNS.map(sign => (
                <button
                  key={sign}
                  onClick={() => { setSelectedSign(sign); setStep('shuffling'); }}
                  className="p-4 rounded-2xl bg-white/5 border border-white/10 hover:border-amber-500/50 hover:bg-white/10 transition-all text-sm font-medium flex flex-col items-center gap-2 active:scale-95"
                >
                  <Sun size={18} className="text-amber-500" />
                  {sign}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* Step 2: Shuffling and Drawing */}
        {step === 'shuffling' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-end">
              <div>
                <h2 className="text-2xl font-serif">Draw Your Path</h2>
                <p className="text-slate-400 text-sm">Select 3 cards for Past, Present, and Future.</p>
              </div>
              <button 
                onClick={autoDraw}
                className="flex items-center gap-2 text-amber-400 text-sm font-medium hover:underline"
              >
                <RefreshCw size={14} /> Auto-Draw
              </button>
            </div>

            {/* Selected Cards Display */}
            <div className="flex justify-center gap-4 min-h-[160px] md:min-h-[220px]">
              {[0, 1, 2].map((i) => (
                <div key={i} className="flex flex-col items-center gap-2">
                  <div className="w-24 h-36 md:w-32 md:h-48 rounded-xl border-2 border-dashed border-white/10 flex items-center justify-center">
                    {drawnCards[i] ? (
                      <div className="bg-white rounded-lg p-2 text-indigo-900 w-full h-full flex flex-col items-center justify-center animate-in zoom-in-95 duration-300 shadow-xl border-2 border-amber-500">
                        <span className="text-4xl">{drawnCards[i].image}</span>
                        <span className="text-[10px] uppercase font-bold text-center mt-2 leading-tight">{drawnCards[i].name}</span>
                      </div>
                    ) : (
                      <span className="text-white/20 text-[10px] uppercase tracking-tighter">
                        {i === 0 ? "Past" : i === 1 ? "Present" : "Future"}
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>

            {/* Deck to draw from */}
            {drawnCards.length < 3 ? (
              <div className="relative h-48 flex items-center justify-center overflow-x-auto py-4">
                <div className="flex -space-x-12 px-12">
                  {[...Array(12)].map((_, i) => (
                    <div 
                      key={i}
                      onClick={() => handleDrawCard(i)}
                      className="w-24 h-36 md:w-32 md:h-48 bg-indigo-950 rounded-xl border border-amber-400/30 shadow-2xl hover:-translate-y-4 transition-transform cursor-pointer flex-shrink-0 flex items-center justify-center"
                      style={{ transform: `rotate(${(i - 6) * 2}deg)` }}
                    >
                      <Moon className="text-amber-500/20" size={24} />
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex justify-center pt-8">
                <button
                  onClick={generateReading}
                  className="bg-gradient-to-r from-amber-500 to-orange-600 text-white px-12 py-4 rounded-full font-bold shadow-xl shadow-amber-500/20 hover:scale-105 active:scale-95 transition-all flex items-center gap-3"
                >
                  <BookOpen size={20} />
                  Reveal Meaning
                </button>
              </div>
            )}
          </div>
        )}

        {/* Step 3: Interpretation */}
        {step === 'interpretation' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-1000">
            <div className="text-center space-y-2">
              <span className="text-amber-500 text-xs font-bold uppercase tracking-widest">Divine Guidance for {selectedSign}</span>
              <h2 className="text-3xl font-serif">The Reading</h2>
            </div>

            <div className="grid grid-cols-3 gap-3 md:gap-6">
              {drawnCards.map((card, i) => (
                <div key={i} className="bg-white/5 rounded-2xl p-4 border border-white/10 text-center space-y-2">
                  <div className="text-xs text-amber-500 font-bold uppercase">
                    {i === 0 ? "Past" : i === 1 ? "Present" : "Future"}
                  </div>
                  <div className="text-3xl">{card.image}</div>
                  <div className="text-sm font-serif font-bold">{card.name}</div>
                </div>
              ))}
            </div>

            <div className="bg-white/5 backdrop-blur-md rounded-3xl p-6 md:p-10 border border-white/10 shadow-inner relative overflow-hidden">
              <div className="absolute top-0 right-0 p-4 text-white/5">
                <Sparkles size={120} />
              </div>
              
              {isLoadingReading ? (
                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                  <Loader2 className="animate-spin text-amber-500" size={40} />
                  <p className="text-slate-400 animate-pulse font-serif italic text-lg text-center">Consulting the cosmos for your {selectedSign} alignment...</p>
                </div>
              ) : (
                <div className="space-y-6 relative z-10">
                  <p className="text-slate-200 leading-relaxed text-lg font-serif first-letter:text-4xl first-letter:font-bold first-letter:text-amber-500 first-letter:mr-1 first-letter:float-left">
                    {readingText}
                  </p>
                  <div className="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent w-full"></div>
                  <div className="flex justify-between items-center">
                    <button 
                      onClick={reset}
                      className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
                    >
                      <RotateCcw size={16} />
                      <span className="text-sm">Start New Reading</span>
                    </button>
                    <div className="flex gap-2">
                       <div className="w-2 h-2 rounded-full bg-amber-500"></div>
                       <div className="w-2 h-2 rounded-full bg-amber-500/50"></div>
                       <div className="w-2 h-2 rounded-full bg-amber-500/20"></div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

      </main>

      {/* Style overrides for card flip animation */}
      <style dangerouslySetInnerHTML={{ __html: `
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
      `}} />
    </div>
  );
}
