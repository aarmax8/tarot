import React, { useState, useEffect } from 'react';
import { 
  Sparkles, 
  Moon, 
  Sun, 
  RotateCcw, 
  BookOpen, 
  User, 
  Loader2,
  RefreshCw
} from 'lucide-react';

// --- Tarot Deck Data ---
const TAROT_DECK = [
  { name: "The Fool", image: "ðŸƒ", meaning: "new beginnings and spontaneous leaps of faith", keyword: "Innocence" },
  { name: "The Magician", image: "ðŸª„", meaning: "the power of manifestation and using your innate tools", keyword: "Willpower" },
  { name: "The High Priestess", image: "ðŸŒ™", meaning: "the whispers of intuition and hidden knowledge", keyword: "Mystery" },
  { name: "The Empress", image: "ðŸŒ¿", meaning: "abundant creativity and nurturing energy", keyword: "Fertility" },
  { name: "The Emperor", image: "ðŸ‘‘", meaning: "structure, authority, and solid foundations", keyword: "Control" },
  { name: "The Hierophant", image: "â›ª", meaning: "tradition, spiritual wisdom, and cultural beliefs", keyword: "Belief" },
  { name: "The Lovers", image: "â¤ï¸", meaning: "harmony in relationships and value-based choices", keyword: "Union" },
  { name: "The Chariot", image: "ðŸ‡", meaning: "victory through willpower and focused determination", keyword: "Drive" },
  { name: "Strength", image: "ðŸ¦", meaning: "inner courage and the power of gentle persuasion", keyword: "Fortitude" },
  { name: "The Hermit", image: "ðŸ•¯ï¸", meaning: "introspection and the light of inner guidance", keyword: "Solitude" },
  { name: "Wheel of Fortune", image: "ðŸŽ¡", meaning: "the cycles of destiny and shifts in karma", keyword: "Luck" },
  { name: "Justice", image: "âš–ï¸", meaning: "fairness, truth, and the balance of cause and effect", keyword: "Truth" },
  { name: "The Hanged Man", image: "ðŸ¦¶", meaning: "surrender to the flow and gaining new perspectives", keyword: "Perspective" },
  { name: "Death", image: "ðŸ’€", meaning: "the closing of one door and the opening of another", keyword: "Transition" },
  { name: "Temperance", image: "ðŸ·", meaning: "patience, moderation, and the blending of opposites", keyword: "Balance" },
  { name: "The Devil", image: "ðŸ˜ˆ", meaning: "attachments that restrict your spiritual growth", keyword: "Shadow" },
  { name: "The Tower", image: "ðŸ°", meaning: "sudden upheaval that clears the way for truth", keyword: "Revelation" },
  { name: "The Star", image: "â­", meaning: "renewed hope and inspiration from the universe", keyword: "Hope" },
  { name: "The Moon", image: "ðŸŒ•", meaning: "navigating the shadows of the subconscious", keyword: "Subconscious" },
  { name: "The Sun", image: "ðŸŒž", meaning: "radiant success, joy, and absolute clarity", keyword: "Vitality" },
  { name: "Judgement", image: "ðŸŽº", meaning: "answering a higher calling and rebirth", keyword: "Calling" },
  { name: "The World", image: "ðŸŒ", meaning: "completion of a major cycle and fulfillment", keyword: "Wholeness" }
];

const ZODIAC_DATA = {
  "Aries": "fiery and impulsive spirit",
  "Taurus": "grounded and persistent nature",
  "Gemini": "dual and inquisitive mind",
  "Cancer": "deeply intuitive and emotional soul",
  "Leo": "radiant and courageous heart",
  "Virgo": "precise and analytical energy",
  "Libra": "harmonious and diplomatic essence",
  "Scorpio": "intense and transformative power",
  "Sagittarius": "adventurous and philosophical outlook",
  "Capricorn": "ambitious and disciplined resolve",
  "Aquarius": "original and visionary perspective",
  "Pisces": "dreamy and empathetic connection"
};

const ZODIAC_SIGNS = Object.keys(ZODIAC_DATA);

export default function App() {
  const [selectedSign, setSelectedSign] = useState(null);
  const [step, setStep] = useState('sign-selection'); 
  const [drawnCards, setDrawnCards] = useState([]);
  const [readingText, setReadingText] = useState("");
  const [isLoadingReading, setIsLoadingReading] = useState(false);
  const [deck] = useState([...TAROT_DECK]);

  // --- Mobile Optimization Hook ---
  useEffect(() => {
    // Inject mobile meta tags to ensure iPhone looks correct
    const meta = document.createElement('meta');
    meta.name = "viewport";
    meta.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover";
    document.getElementsByTagName('head')[0].appendChild(meta);
    
    // Set theme color for iPhone status bar
    const themeMeta = document.createElement('meta');
    themeMeta.name = "theme-color";
    themeMeta.content = "#020617";
    document.getElementsByTagName('head')[0].appendChild(themeMeta);
    
    // Prevent scrolling bounce on some mobile browsers
    document.body.style.overscrollBehavior = 'none';
    document.body.style.backgroundColor = '#020617';
    
    return () => {
      document.body.style.overscrollBehavior = 'auto';
    };
  }, []);

  const handleDrawCard = (index) => {
    if (drawnCards.length >= 3) return;
    const card = deck[index % deck.length];
    if (drawnCards.find(c => c.name === card.name)) return;
    setDrawnCards(prev => [...prev, card]);
  };

  const autoDraw = () => {
    const shuffled = [...TAROT_DECK].sort(() => Math.random() - 0.5);
    setDrawnCards(shuffled.slice(0, 3));
  };

  const generateLocalReading = () => {
    setIsLoadingReading(true);
    setStep('interpretation');

    setTimeout(() => {
      const [past, present, future] = drawnCards;
      const zodiacTrait = ZODIAC_DATA[selectedSign];

      const intro = `As a ${selectedSign}, your ${zodiacTrait} is currently reacting to the cosmic alignment. `;
      const pastPart = `In the recent past, ${past.name} indicated a period of ${past.meaning}. `;
      const presentPart = `Right now, ${present.name} suggests you are navigating ${present.meaning}. `;
      const futurePart = `Looking ahead, ${future.name} promises ${future.meaning}. `;
      const advice = `Trust in your ${selectedSign} intuition.`;

      setReadingText(intro + pastPart + presentPart + futurePart + advice);
      setIsLoadingReading(false);
    }, 1500);
  };

  const reset = () => {
    setStep('sign-selection');
    setDrawnCards([]);
    setReadingText("");
    setSelectedSign(null);
  };

  return (
    <div className="fixed inset-0 bg-slate-950 text-slate-100 font-sans selection:bg-amber-500/30 overflow-y-auto overflow-x-hidden flex flex-col">
      {/* Dynamic Background */}
      <div className="fixed inset-0 pointer-events-none z-0">
        <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] bg-indigo-900/20 blur-[120px] rounded-full"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-purple-900/20 blur-[120px] rounded-full"></div>
      </div>

      {/* Header - Optimized for iPhone Notch */}
      <header className="relative z-20 pt-[env(safe-area-inset-top)] px-6 pb-4 flex items-center justify-between border-b border-white/10 backdrop-blur-xl bg-slate-950/50 sticky top-0">
        <div className="flex items-center gap-2 mt-2">
          <div className="w-9 h-9 bg-gradient-to-br from-amber-400 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-orange-600/20">
            <Sparkles className="text-white" size={18} />
          </div>
          <h1 className="text-lg font-serif font-bold tracking-tight">Stellar Tarot</h1>
        </div>
        {selectedSign && (
          <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10 mt-2">
            <User size={12} className="text-amber-400" />
            <span className="text-[10px] font-bold uppercase tracking-widest">{selectedSign}</span>
          </div>
        )}
      </header>

      {/* Main App Content */}
      <main className="relative z-10 w-full max-w-lg mx-auto p-6 flex-grow flex flex-col">
        
        {step === 'sign-selection' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500 flex-grow">
            <div className="text-center space-y-2 py-6">
              <h2 className="text-3xl font-serif">Seek your path</h2>
              <p className="text-slate-400 text-sm">Align the cards with your zodiac energy.</p>
            </div>
            <div className="grid grid-cols-3 gap-3">
              {ZODIAC_SIGNS.map(sign => (
                <button
                  key={sign}
                  onClick={() => { setSelectedSign(sign); setStep('shuffling'); }}
                  className="aspect-square rounded-2xl bg-white/5 border border-white/10 flex flex-col items-center justify-center gap-2 active:scale-90 transition-all active:bg-amber-500/20 active:border-amber-500"
                >
                  <Sun size={20} className="text-amber-500/80" />
                  <span className="text-[10px] font-bold uppercase tracking-tighter">{sign}</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 'shuffling' && (
          <div className="space-y-8 animate-in fade-in duration-500 flex flex-col flex-grow">
            <div className="flex justify-between items-end">
              <div>
                <h2 className="text-xl font-serif">Draw Three Cards</h2>
                <p className="text-slate-400 text-xs">Past â€¢ Present â€¢ Future</p>
              </div>
              <button 
                onClick={autoDraw}
                className="flex items-center gap-1.5 text-amber-500 text-xs font-bold uppercase"
              >
                <RefreshCw size={12} /> Auto
              </button>
            </div>

            <div className="flex justify-center gap-3">
              {[0, 1, 2].map((i) => (
                <div key={i} className="flex-1 max-w-[100px]">
                  <div className="aspect-[2/3] rounded-xl border-2 border-dashed border-white/10 flex items-center justify-center relative overflow-hidden">
                    {drawnCards[i] ? (
                      <div className="bg-white text-indigo-950 w-full h-full flex flex-col items-center justify-center p-2 animate-in zoom-in-90 shadow-2xl">
                        <span className="text-3xl">{drawnCards[i].image}</span>
                        <span className="text-[8px] uppercase font-black text-center mt-2 leading-none">{drawnCards[i].name}</span>
                      </div>
                    ) : (
                      <span className="text-white/10 text-[8px] font-bold uppercase rotate-90 whitespace-nowrap">
                        {i === 0 ? "Past" : i === 1 ? "Present" : "Future"}
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>

            {drawnCards.length < 3 ? (
              <div className="flex-grow flex items-center justify-center py-10">
                <div className="flex -space-x-14 overflow-visible">
                  {[...Array(8)].map((_, i) => (
                    <div 
                      key={i}
                      onClick={() => handleDrawCard(i)}
                      className="w-20 h-32 bg-indigo-950 rounded-xl border border-amber-400/20 shadow-xl active:-translate-y-6 transition-all cursor-pointer flex items-center justify-center"
                      style={{ transform: `rotate(${(i - 3.5) * 6}deg)` }}
                    >
                      <Moon className="text-amber-500/10" size={20} />
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="pt-8 flex justify-center">
                <button
                  onClick={generateLocalReading}
                  className="w-full max-w-xs bg-gradient-to-r from-amber-500 to-orange-600 text-white h-14 rounded-2xl font-bold shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3"
                >
                  <BookOpen size={18} />
                  Interpret My Stars
                </button>
              </div>
            )}
          </div>
        )}

        {step === 'interpretation' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-8 duration-700 flex flex-col flex-grow">
            <div className="text-center space-y-1">
              <span className="text-amber-500 text-[10px] font-bold uppercase tracking-widest">Divine Alignment</span>
              <h2 className="text-2xl font-serif">The Path of {selectedSign}</h2>
            </div>

            <div className="bg-white/5 backdrop-blur-md rounded-[2.5rem] p-8 border border-white/10 shadow-inner relative overflow-hidden flex-grow flex flex-col justify-center">
              {isLoadingReading ? (
                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                  <Loader2 className="animate-spin text-amber-500" size={32} />
                  <p className="text-slate-400 italic text-sm">Aligning your energy...</p>
                </div>
              ) : (
                <div className="space-y-6">
                  <p className="text-slate-200 leading-relaxed text-base font-serif text-justify first-letter:text-3xl first-letter:text-amber-500 first-letter:font-bold">
                    {readingText}
                  </p>
                  <div className="h-px bg-white/10 w-full"></div>
                  <button 
                    onClick={reset}
                    className="w-full h-12 rounded-xl bg-white/5 border border-white/10 text-slate-300 text-xs font-bold uppercase flex items-center justify-center gap-2 active:bg-white/10"
                  >
                    <RotateCcw size={14} /> New Reading
                  </button>
                </div>
              )}
            </div>
            
            {/* Safe Area Spacer for iPhone Home Bar */}
            <div className="h-[env(safe-area-inset-bottom)] min-h-[16px]"></div>
          </div>
        )}
      </main>
      
      {/* Mobile-Specific CSS */}
      <style dangerouslySetInnerHTML={{ __html: `
        @supports (padding-top: env(safe-area-inset-top)) {
          .pt-safe { padding-top: env(safe-area-inset-top); }
          .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        }
        body { margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; position: fixed; }
      `}} />
    </div>
  );
}
